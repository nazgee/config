# we need some helpers from ip_aliases
source "`dirname $BASH_SOURCE`/ip_aliases"

function nazgee-adb-export() {
	local VDIIP="`ifconfig | grep -A 1 tap0 | tail -n1 | awk "-F " '{print $2 }'`"
	
	if [ -z "$VDIIP" ]; then
		echo "NoMachine port sharing not enabled." > /dev/stderr
		echo "" > /dev/stderr
		echo "Press ctrl+alt+0 and go to \"Devices-> Connect a network port -> Local ports -> Add a network port\"." > /dev/stderr
		echo "Share TCP 5038:5038 if you want your local adb shared with VDI." > /dev/stderr
		echo "When done, invoke ${FUNCNAME[0]} to force adb to connect to adb deamon :5038 on your local system." > /dev/stderr
		return 1
	fi

	local IP1=`nazgee-previp "$VDIIP"`
	local IP2=`nazgee-nextip "$VDIIP"`

	# kill local server on 5038 (in case it runs)
	adb -P 5038 kill-server -H localhost > /dev/null 2>&1

	# try first IP
	if adb -P 5038 -H $IP1 devices > /dev/null 2>&1; then
		export ADB_SERVER_SOCKET=tcp:$IP1:5038
		echo  "ADB_SERVER_SOCKET=tcp:$IP1:5038 (this will allow you to use your local adb from VDI)" > /dev/stderr
	# try second IP
	elif adb -P 5038 -H $IP2 devices > /dev/null 2>&1; then
		export ADB_SERVER_SOCKET=tcp:$IP2:5038
		echo  "ADB_SERVER_SOCKET=tcp:$IP2:5038 (this will allow you to use your local adb from VDI)" > /dev/stderr
	# give up
	else
		echo "Can't connect to adb host on $IP1:5038 or $IP2:5038." > /dev/stderr
		echo "Have you started \"adb -a -P 5038 nodaemon server start\" on your machine?" > /dev/stderr
	fi
}

# helper to get a PID of a process by name
# $1: name (or part of name) of a process
function nazgee-apid() {
	adb shell ps | grep -i "$1" | awk "-F " '{print $2 }'
}

# helper for showing logcat only of a single process
# $1: name (or part of name) of a process
function nazgee-aplog() {
	local PID=$(nazgee-apid "$1")
	adb logcat | grep -i " $PID "
}

# shortcut for root & remount
function nazgee-arr() {
	adb root && adb remount
}

# shortcut for root, remount, sync & reboot
function nazgee-arrsr() {
	nazgee-arr && adb sync && adb shell sync && adb reboot
}

